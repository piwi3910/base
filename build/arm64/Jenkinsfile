pipeline {
  environment {
    dockerhub_account = "piwi3910"
    ubuntu_imagename = "ubuntu"
    alpine_imagename = "alpine"
    docker_hub_cred = 'docker_reg'
    nexus_cred = 'f06e38c2-f3b3-43a2-a9d1-3dabb64ca873'
    alpine_dockerImage = ''
    ubuntu_dockerImage = ''
    alpine_version = "3.13.5"
    ubuntu_version = "20.04"
    nexus_registry = "registry.watteel.dev"
  }
  agent {
    kubernetes {
      yamlFile 'buildpod_arm64.yaml'
    }
  }  
  triggers { cron('0 0 * * 0')} // trigger the master branch to build weekly
  stages {
    stage('Build and Push') {
      matrix {
        axes {
          axis {
            name 'VERSION'
            values '3.13.5', '3.14.1'
          }  
        }
        stages {
          stage('Build Alpine') {
            steps {
              container('docker') {
                script {
                  docker.withRegistry( "https://${nexus_registry}", nexus_cred ) {                  
                    alpine_dockerImage = docker.build("${alpine_imagename}:${BUILD_ID}", "--build-arg VERSION=${VERSION} ${WORKSPACE}/alpine" ) 
                  }  
                }  
              }
            }    
          }     
          stage('Push Alpine to DockerHub') {       
            steps {
              container('docker') {
                script {
                  docker.withRegistry( '', docker_hub_cred ) {
                    sh("docker tag ${alpine_imagename}:${BUILD_ID} ${dockerhub_account}/${alpine_imagename}:${BUILD_ID}")
                    alpine_dockerImage_hub = docker.image("${dockerhub_account}/${alpine_imagename}:${BUILD_ID}")
                    alpine_dockerImage_hub.push('${VERSION}')
                  }
                }
              }
            }    
          }  
          stage('Push Alpine to Internal Nexus') {          
            steps {
              container('docker') {
                script {
                  docker.withRegistry( "https://${nexus_registry}", nexus_cred ) {
                    sh("docker tag ${alpine_imagename}:${BUILD_ID} ${nexus_registry}/${alpine_imagename}:${BUILD_ID}")
                    alpine_dockerImage_interal = docker.image("${nexus_registry}/${alpine_imagename}:${BUILD_ID}")                    
                    alpine_dockerImage_interal.push('${VERSION}')
                  }
                }
              }
            }    
          }  
        }
      }  
    }        
  }
}
